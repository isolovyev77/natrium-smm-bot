import os
from openai import OpenAI
from dotenv import load_dotenv
from pathlib import Path
import httpx

# –ó–∞–≥—Ä—É–∑–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
load_dotenv()

class NatriumBot:
    def __init__(self, prompts_dir: str = "prompts"):
        self.api_key = os.getenv("YANDEX_CLOUD_API_KEY")
        self.folder_id = os.getenv("YANDEX_FOLDER_ID")
        self.agent_id = os.getenv("YANDEX_AGENT_ID")
        self.prompts_dir = Path(__file__).parent.parent / prompts_dir
        
        # –°–æ–∑–¥–∞–µ–º HTTP –∫–ª–∏–µ–Ω—Ç —Å —É–≤–µ–ª–∏—á–µ–Ω–Ω—ã–º —Ç–∞–π–º–∞—É—Ç–æ–º (–¥–ª—è –¥–ª–∏–Ω–Ω—ã—Ö —Ç–µ–º)
        http_client = httpx.Client(
            timeout=httpx.Timeout(120.0, connect=10.0),  # 120 —Å–µ–∫—É–Ω–¥ –Ω–∞ –æ—Ç–≤–µ—Ç, 10 –Ω–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
        )
        
        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–ª–∏–µ–Ω—Ç–∞ OpenAI
        self.client = OpenAI(
            api_key=self.api_key,
            base_url="https://rest-assistant.api.cloud.yandex.net/v1",
            project=self.folder_id,
            http_client=http_client
        )
    
    def _format_variables(self, variables: dict) -> str:
        """–§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ —Å—Ç—Ä–æ–∫—É –¥–ª—è additional_instructions"""
        if not variables:
            return ""
        lines = ["–ò—Å–ø–æ–ª—å–∑—É–π —Å–ª–µ–¥—É—é—â–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ:"]
        for key, value in variables.items():
            lines.append(f"{key}: {value}")
        return "\n".join(lines)
    

    def generate_themes(self, technique: str = "cov+cok", custom_input: str = None) -> tuple:
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç 10 —Ç–µ–º (–ø—É—Å—Ç–∞—è USER_THEME)

        Returns:
            tuple: (themes_text, usage_dict)
        """
        import time

        variables = {
            "TECHNIQUE": technique,
            "USER_THEME": "",
            "POST_LENGTH": "500"
        }
        
        # –î–æ–±–∞–≤–ª—è–µ–º timestamp –¥–ª—è —Ä–∞–Ω–¥–æ–º–∏–∑–∞—Ü–∏–∏
        timestamp_hint = f"–ó–∞–ø—Ä–æ—Å #{int(time.time() % 10000)}"

        # –§–æ—Ä–º–∏—Ä—É–µ–º —è–≤–Ω—É—é –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é
        if custom_input:
            input_text = f"""–ó–ê–î–ê–ß–ê: {custom_input}

–í–ê–ñ–ù–û:
- –≠—Ç–æ –∑–∞–ø—Ä–æ—Å –Ω–∞ –ì–ï–ù–ï–†–ê–¶–ò–Æ –¢–ï–ú, –ù–ï –ø–æ—Å—Ç–∞!
- USER_THEME = "" (–ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞)
- –ö–∞–∂–¥–∞—è —Ç–µ–º–∞ –ù–ï –ë–û–õ–ï–ï 5 –°–õ–û–í
- –¢–µ–º—ã –Ω–∞ –û–ë–´–ß–ù–û–ú —Ä–µ–≥–∏—Å—Ç—Ä–µ (–Ω–µ CAPS!)
- –î–æ–±–∞–≤—å –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –≤ [–∫–≤–∞–¥—Ä–∞—Ç–Ω—ã—Ö —Å–∫–æ–±–∫–∞—Ö]

üî• –î–õ–Ø –†–ê–ó–ù–û–û–ë–†–ê–ó–ò–Ø –ò –ù–û–í–ò–ó–ù–´:
- –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –∏—Å–ø–æ–ª—å–∑—É–π –∫–Ω–∏–≥—É "–ë–æ–ª—å—à–∞—è –∫–Ω–∏–≥–∞ –æ —Å–æ—Ü—Å–µ—Ç—è—Ö" –≤ FileSearch
- –ü—Ä–∏–º–µ–Ω—è–π —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –∏–∑ –∫–Ω–∏–≥–∏: –≤–∏—Ä—É—Å–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã, —Ö—É–∫–∏, —Ç—Ä–∏–≥–≥–µ—Ä—ã
- –ì–µ–Ω–µ—Ä–∏—Ä—É–π –ù–ï–°–¢–ê–ù–î–ê–†–¢–ù–´–ï —Ç–µ–º—ã (–Ω–µ —Ç–æ–ª—å–∫–æ –±–∞–∑–æ–≤—ã–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è/–ø–∏—Ç–∞–Ω–∏–µ)
- –ò—Å–ø–æ–ª—å–∑—É–π –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–Ω–¥—ã 2026 –≥–æ–¥–∞ –∏–∑ Web Search
- –ú–∏–∫—Å—É–π —Ñ–æ—Ä–º–∞—Ç—ã: –≤–æ–ø—Ä–æ—Å—ã, –º–∏—Ñ—ã, –∏–Ω—Å–∞–π—Ç—ã, –∫–µ–π—Å—ã, —á–µ–ª–ª–µ–Ω–¥–∂–∏

‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û - –ù–ï –ü–û–í–¢–û–†–Ø–ô–°–Ø:
- –ì–µ–Ω–µ—Ä–∏—Ä—É–π –°–û–í–ï–†–®–ï–ù–ù–û –†–ê–ó–ù–´–ï —Ç–µ–º—ã –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ
- –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π —à–∞–±–ª–æ–Ω–Ω—ã–µ —Ç–µ–º—ã (–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ Open, –¢–µ—Ö–Ω–∏–∫–∞ –≥—Ä–µ–±–ª–∏, –≠–ª–µ–∫—Ç—Ä–æ–ª–∏—Ç—ã...)
- –ü—Ä–æ—è–≤–ª—è–π –ö–†–ï–ê–¢–ò–í–ù–û–°–¢–¨ –∏ –û–†–ò–ì–ò–ù–ê–õ–¨–ù–û–°–¢–¨
- –ö–∞–∂–¥—ã–π –Ω–∞–±–æ—Ä —Ç–µ–º –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –£–ù–ò–ö–ê–õ–¨–ù–´–ú
- –ó–∞–ø—Ä–æ—Å: {timestamp_hint}

–§–æ—Ä–º–∞—Ç –≤—ã–≤–æ–¥–∞:
1Ô∏è‚É£ –¢–µ–º–∞ 1 [–∏—Å—Ç–æ—á–Ω–∏–∫]
2Ô∏è‚É£ –¢–µ–º–∞ 2 [–∏—Å—Ç–æ—á–Ω–∏–∫]
...
üîü –¢–µ–º–∞ 10 [–∏—Å—Ç–æ—á–Ω–∏–∫]"""
        else:
            input_text = f"""–ó–ê–î–ê–ß–ê: –°–≥–µ–Ω–µ—Ä–∏—Ä—É–π 10 –ê–ö–¢–£–ê–õ–¨–ù–´–• –¢–ï–ú –¥–ª—è –ø–æ—Å—Ç–æ–≤.

–í–ê–ñ–ù–û:
- –≠—Ç–æ –∑–∞–ø—Ä–æ—Å –Ω–∞ –ì–ï–ù–ï–†–ê–¶–ò–Æ –¢–ï–ú, –ù–ï –ø–æ—Å—Ç–∞!
- USER_THEME = "" (–ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞)
- –ö–∞–∂–¥–∞—è —Ç–µ–º–∞ –ù–ï –ë–û–õ–ï–ï 5-7 –°–õ–û–í
- –¢–µ–º—ã –Ω–∞ –û–ë–´–ß–ù–û–ú —Ä–µ–≥–∏—Å—Ç—Ä–µ (–Ω–µ CAPS!)
- –î–æ–±–∞–≤—å –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –≤ [–∫–≤–∞–¥—Ä–∞—Ç–Ω—ã—Ö —Å–∫–æ–±–∫–∞—Ö]

üîç –ü–û–†–Ø–î–û–ö –†–ê–ë–û–¢–´:
1. –ò—Å–ø–æ–ª—å–∑—É–π Web Search –¥–ª—è –ø–æ–∏—Å–∫–∞ –ê–ö–¢–£–ê–õ–¨–ù–´–• —Ç–µ–º 2026 –≥–æ–¥–∞
2. –ò—Å–ø–æ–ª—å–∑—É–π File Search –¥–ª—è –ø–æ–∏—Å–∫–∞ –ò–ù–¢–ï–†–ï–°–ù–û–ì–û –º–∞—Ç–µ—Ä–∏–∞–ª–∞
3. –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –Ω–∞–π–¥–∏ –≤ File Search –∫–Ω–∏–≥—É "–ë–æ–ª—å—à–∞—è –∫–Ω–∏–≥–∞ –æ —Å–æ—Ü—Å–µ—Ç—è—Ö"
4. –ü—Ä–æ–ø—É—Å—Ç–∏ –í–°–ï —Ç–µ–º—ã —á–µ—Ä–µ–∑ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –∏–∑ –∫–Ω–∏–≥–∏ –æ —Å–æ—Ü—Å–µ—Ç—è—Ö

üî• –§–û–†–ú–ê–¢–´ –¢–ï–ú (–∏—Å–ø–æ–ª—å–∑—É–π —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–Ω—ã–µ):
- –ü—Ä–æ–≤–æ–∫–∞—Ü–∏–æ–Ω–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã: "–ø–µ—Ä–∏–æ–¥–∏–∑–∞—Ü–∏—è: –º–∏—Ñ –∏–ª–∏ —Ä–µ–∞–ª—å–Ω–æ—Å—Ç—å?"
- –§–æ—Ä–º–∞—Ç "–∫–∞–∫": "–∫–∞–∫ –≥—Ä–µ–±–ª—è concept2 –º–µ–Ω—è–µ—Ç —Ç–µ–ª–æ"
- –°–µ–∫—Ä–µ—Ç—ã/–∏–Ω—Å–∞–π—Ç—ã: "crossfit open 2026: —Å–µ–∫—Ä–µ—Ç—ã –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏"
- –†–∞–∑–≤–µ–Ω—á–∞–Ω–∏–µ –º–∏—Ñ–æ–≤: "–ø–∏—Ç–∞–Ω–∏–µ –∞—Ç–ª–µ—Ç–∞: —Ä–∞–∑–≤–µ–Ω—á–∏–≤–∞–µ–º –º–∏—Ñ—ã"
- –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è: "—Ç–≤–æ–π –ª–∏—á–Ω—ã–π –∞–ª–≥–æ—Ä–∏—Ç–º —É—Å–ø–µ—Ö–∞"
- –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ü–∏—Ñ—Ä—ã: "—Å–æ–Ω –∞—Ç–ª–µ—Ç–∞: 7-9 —á–∞—Å–æ–≤"

‚ö†Ô∏è –ó–ê–ü–†–ï–©–ï–ù–û:
- –°–∫—É—á–Ω—ã–µ –±–∞–∑–æ–≤—ã–µ —Ç–µ–º—ã ("—Ç–µ—Ö–Ω–∏–∫–∞ –≥—Ä–µ–±–ª–∏", "–ø–µ—Ä–∏–æ–¥–∏–∑–∞—Ü–∏—è –Ω–∞–≥—Ä—É–∑–æ–∫")
- –¢–æ–ª—å–∫–æ –Ω–∞–∑–≤–∞–Ω–∏–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –±–µ–∑ —Ö—É–∫–∞
- –¢–µ–º—ã –±–µ–∑ —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ —Ç—Ä–∏–≥–≥–µ—Ä–∞

‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û - –ù–ï –ü–û–í–¢–û–†–Ø–ô–°–Ø:
- –ì–µ–Ω–µ—Ä–∏—Ä—É–π –°–û–í–ï–†–®–ï–ù–ù–û –†–ê–ó–ù–´–ï —Ç–µ–º—ã –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ
- –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π —à–∞–±–ª–æ–Ω–Ω—ã–µ —Ç–µ–º—ã (–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ Open, –¢–µ—Ö–Ω–∏–∫–∞ –≥—Ä–µ–±–ª–∏, –≠–ª–µ–∫—Ç—Ä–æ–ª–∏—Ç—ã...)
- –ü—Ä–æ—è–≤–ª—è–π –ö–†–ï–ê–¢–ò–í–ù–û–°–¢–¨ –∏ –û–†–ò–ì–ò–ù–ê–õ–¨–ù–û–°–¢–¨
- –ö–∞–∂–¥—ã–π –Ω–∞–±–æ—Ä —Ç–µ–º –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –£–ù–ò–ö–ê–õ–¨–ù–´–ú
- –ó–∞–ø—Ä–æ—Å: {timestamp_hint}

–§–æ—Ä–º–∞—Ç –≤—ã–≤–æ–¥–∞:
1Ô∏è‚É£ –¢–µ–º–∞ 1 [–∏—Å—Ç–æ—á–Ω–∏–∫]
2Ô∏è‚É£ –¢–µ–º–∞ 2 [–∏—Å—Ç–æ—á–Ω–∏–∫]
...
üîü –¢–µ–º–∞ 10 [–∏—Å—Ç–æ—á–Ω–∏–∫]"""

        return self._call_api(variables, input_text=input_text)

    def generate_post(self, theme: str, technique: str = "cov+cok", post_length: int = 500) -> tuple:
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ø–æ—Å—Ç –ø–æ —Ç–µ–º–µ

        Returns:
            tuple: (post_text, usage_dict)
        """
        variables = {
            "TECHNIQUE": technique,
            "USER_THEME": theme,
            "POST_LENGTH": str(post_length)
        }
        
        # –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: —è–≤–Ω–æ —É–∫–∞–∑—ã–≤–∞–µ–º, —á—Ç–æ —ç—Ç–æ –∑–∞–ø—Ä–æ—Å –Ω–∞ –ü–û–°–¢, –∞ –Ω–µ —Ç–µ–º—ã
        input_text = f"""–°–≥–µ–Ω–µ—Ä–∏—Ä—É–π –ø–æ—Å—Ç –Ω–∞ —Ç–µ–º—É "{theme}" —Å –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ–º –¥–∞–Ω–Ω—ã—Ö –∏–∑ File Search –∏ Web Search —Å –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ–º Chain of Knowledge –∏ –ø–µ—Ä–µ–ø—Ä–æ–≤–µ—Ä–∫–æ–π —Ñ–∞–∫—Ç–æ–≤ cov+cok

‚ö†Ô∏è –í–ê–ñ–ù–û:
- USER_THEME = "{theme}" (–ù–ï –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞!)
- –≠—Ç–æ –∑–∞–ø—Ä–æ—Å –Ω–∞ –ì–ï–ù–ï–†–ê–¶–ò–Æ –ü–û–°–¢–ê, –ù–ï —Ç–µ–º!
- –î–ª–∏–Ω–∞: {post_length} —Å–∏–º–≤–æ–ª–æ–≤
- –¢–µ—Ö–Ω–∏–∫–∞: {technique}

üîç –ü–û–†–Ø–î–û–ö –†–ê–ë–û–¢–´ (–ø—Ä–∏–º–µ–Ω—è–π CoV+CoK):
1. –ò—Å–ø–æ–ª—å–∑—É–π File Search –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –ø–æ —Ç–µ–º–µ (–ë–æ–≥–∞—á–µ–≤–∞, CrossFit, –∫–Ω–∏–≥–∞ –æ —Å–æ—Ü—Å–µ—Ç—è—Ö)
2. –í—ã–ø–æ–ª–Ω–∏ Web Search –¥–ª—è –ø–æ–∏—Å–∫–∞ –∞–∫—Ç—É–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ 2026 –≥–æ–¥–∞, –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–π –∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —Ü–∏—Ñ—Ä
3. –ü—Ä–æ–≤–µ—Ä—å –ø–æ–ª—É—á–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—é –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ (WHO, CrossFit.com, PubMed, –Ω–∞—É—á–Ω—ã–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è)
4. –°–≥–µ–Ω–µ—Ä–∏—Ä—É–π –ø–æ—Å—Ç, —Å–æ–±–ª—é–¥–∞—è –≤—Å–µ –∑–∞–¥–∞–Ω–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ —Å—Ç–∏–ª—é –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ –∏–∑ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞

üî• –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û:
- –ó–∞–≥–æ–ª–æ–≤–∫–∏ —Å–µ–∫—Ü–∏–π –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –≤ ** (–Ω–∞–ø—Ä–∏–º–µ—Ä: üî• **–ù–∞–∑–≤–∞–Ω–∏–µ —Å–µ–∫—Ü–∏–∏:**)
- –ö–∞–∂–¥—ã–π —Ñ–∞–∫—Ç —Å –∏—Å—Ç–æ—á–Ω–∏–∫–æ–º [WHO]/[PubMed]/[CrossFit]/[–ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è]
- –ë–µ–∑ –º–∞—Ä–∫–µ—Ä–∞ ">" –≤ –Ω–∞—á–∞–ª–µ (–Ω–µ —Ü–∏—Ç–∞—Ç–∞!)"""

        # –î–æ–±–∞–≤–ª—è–µ–º –∫–ª—é—á–µ–≤—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è –∫–∞–∂–¥–æ–π —Ç–µ—Ö–Ω–∏–∫–∏
        if technique == "cov+cok":
            input_text += """\n\n‚úÖ –ü–æ—Å–ª–µ —Å–±–æ—Ä–∞ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π –ø–æ—Å—Ç –ø–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ –∏–∑ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞"""

        elif technique == "few_shot":
            input_text += """\n\n‚úÖ Few-Shot —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è:
- –ò–∑—É—á–∏ –ø—Ä–∏–º–µ—Ä—ã –ø–æ—Å—Ç–æ–≤ –≤ FileSearch
- –ò—Å–ø–æ–ª—å–∑—É–π –∏—Ö —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∏ —Å—Ç–∏–ª—å
- –°–æ—Ö—Ä–∞–Ω–∏ —Ç–æ–Ω –ù–∞—Ç—Ä–∏—É–º –§–∏—Ç–Ω–µ—Å—Å"""

        return self._call_api(variables, input_text=input_text)

    def _call_api(self, variables: dict, input_text: str = "–í—ã–ø–æ–ª–Ω–∏ –∑–∞–¥–∞—á—É") -> tuple:
        """–í—ã–ø–æ–ª–Ω—è–µ—Ç –∑–∞–ø—Ä–æ—Å –∫ API Yandex Cloud Assistant

        Returns:
            tuple: (result_text, usage_dict) –≥–¥–µ usage_dict —Å–æ–¥–µ—Ä–∂–∏—Ç inputTextTokens, completionTokens, totalTokens
        """
        try:
            # –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ UTF-8 (—É–¥–∞–ª—è–µ–º —Å—É—Ä—Ä–æ–≥–∞—Ç–Ω—ã–µ –ø–∞—Ä—ã)
            input_text = input_text.encode('utf-8', errors='ignore').decode('utf-8')

            # –°–æ–∑–¥–∞–µ–º thread
            thread = self.client.beta.threads.create()
            
            # –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ thread
            self.client.beta.threads.messages.create(
                thread_id=thread.id,
                role="user",
                content=input_text
            )
            
            # –ó–∞–ø—É—Å–∫–∞–µ–º –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞
            run = self.client.beta.threads.runs.create_and_poll(
                thread_id=thread.id,
                assistant_id=self.agent_id,
                additional_instructions=self._format_variables(variables) if variables else None
            )
            
            # –ü–æ–ª—É—á–∞–µ–º –æ—Ç–≤–µ—Ç
            messages = self.client.beta.threads.messages.list(thread_id=thread.id)
            response_message = messages.data[0]
            result = response_message.content[0].text.value

            # –ò–∑–≤–ª–µ–∫–∞–µ–º usage –¥–∞–Ω–Ω—ã–µ (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω—ã)
            usage = {}
            if hasattr(run, 'usage') and run.usage:
                usage = {
                    'input_tokens': getattr(run.usage, 'prompt_tokens', 0),
                    'output_tokens': getattr(run.usage, 'completion_tokens', 0),
                    'total_tokens': getattr(response.usage, 'total_tokens', 0),
                    'input_tokens_details': getattr(response.usage, 'input_tokens_details', None),
                    'output_tokens_details': getattr(response.usage, 'output_tokens_details', None)
                }

            return result, usage

        except Exception as e:
            print(f"‚ùå –û–®–ò–ë–ö–ê API: {e}")
            raise

import os
from dotenv import load_dotenv
from pathlib import Path
import httpx
import json
import logging

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logger = logging.getLogger(__name__)

# –ó–∞–≥—Ä—É–∑–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
load_dotenv()

class NatriumBot:
    def __init__(self, prompts_dir: str = "prompts"):
        self.api_key = os.getenv("YANDEX_CLOUD_API_KEY")
        self.folder_id = os.getenv("YANDEX_FOLDER_ID")
        self.agent_id = os.getenv("YANDEX_AGENT_ID")
        self.prompts_dir = Path(__file__).parent.parent / prompts_dir
        
        # –°–æ–∑–¥–∞–µ–º HTTP –∫–ª–∏–µ–Ω—Ç —Å —É–≤–µ–ª–∏—á–µ–Ω–Ω—ã–º —Ç–∞–π–º–∞—É—Ç–æ–º (–¥–ª—è –¥–ª–∏–Ω–Ω—ã—Ö —Ç–µ–º)
        self.http_client = httpx.Client(
            timeout=httpx.Timeout(120.0, connect=10.0),
            headers={
                "Authorization": f"Api-Key {self.api_key}",
                "x-folder-id": self.folder_id,
                "Content-Type": "application/json"
            }
        )
        
        self.base_url = "https://rest-assistant.api.cloud.yandex.net/v1"
    
    def update_agent_prompt(self, prompt_file: str = "agent_system_prompt.md") -> bool:
        """–û–±–Ω–æ–≤–ª—è–µ—Ç —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –∞–≥–µ–Ω—Ç–∞ –≤ Yandex Cloud
        
        Args:
            prompt_file: –∏–º—è —Ñ–∞–π–ª–∞ —Å –ø—Ä–æ–º–ø—Ç–æ–º –≤ prompts_dir
            
        Returns:
            bool: True –µ—Å–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ
        """
        try:
            # –ß–∏—Ç–∞–µ–º –Ω–æ–≤—ã–π –ø—Ä–æ–º–ø—Ç –∏–∑ —Ñ–∞–π–ª–∞
            prompt_path = self.prompts_dir / prompt_file
            if not prompt_path.exists():
                logger.error(f"Prompt file not found: {prompt_path}")
                return False
            
            with open(prompt_path, 'r', encoding='utf-8') as f:
                new_prompt = f.read()
            
            logger.info(f"Updating agent {self.agent_id} with prompt from {prompt_file}")
            logger.info(f"Prompt length: {len(new_prompt)} chars")
            
            # –û–±–Ω–æ–≤–ª—è–µ–º –∞–≥–µ–Ω—Ç–∞ —á–µ—Ä–µ–∑ API
            payload = {
                "prompt": new_prompt,
                "name": "Natrium SMM Bot"  # –ú–æ–∂–Ω–æ –∑–∞–¥–∞—Ç—å –∏–º—è –∞–≥–µ–Ω—Ç–∞
            }
            
            response = self.http_client.patch(
                f"{self.base_url}/agents/{self.agent_id}",
                json=payload
            )
            response.raise_for_status()
            
            logger.info(f"‚úÖ Agent prompt updated successfully!")
            return True
            
        except Exception as e:
            logger.error(f"‚ùå Failed to update agent prompt: {e}")
            return False
    
    def _format_variables(self, variables: dict) -> str:
        """–§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ —Å—Ç—Ä–æ–∫—É –¥–ª—è additional_instructions"""
        if not variables:
            return ""
        lines = ["–ò—Å–ø–æ–ª—å–∑—É–π —Å–ª–µ–¥—É—é—â–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ:"]
        for key, value in variables.items():
            lines.append(f"{key}: {value}")
        return "\n".join(lines)
    

    def generate_themes(self, technique: str = "cov+cok", custom_input: str = None, previous_themes: list = None) -> tuple:
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç 10 —Ç–µ–º (–ø—É—Å—Ç–∞—è USER_THEME)

        Args:
            technique: —Ç–µ—Ö–Ω–∏–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
            custom_input: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π input (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
            previous_themes: —Å–ø–∏—Å–æ–∫ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —Ç–µ–º –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π

        Returns:
            tuple: (themes_text, usage_dict)
        """
        import time

        variables = {
            "TECHNIQUE": technique,
            "USER_THEME": "",
            "POST_LENGTH": "500"
        }
        
        # –î–æ–±–∞–≤–ª—è–µ–º timestamp –¥–ª—è —Ä–∞–Ω–¥–æ–º–∏–∑–∞—Ü–∏–∏
        timestamp_hint = f"–ó–∞–ø—Ä–æ—Å #{int(time.time() % 10000)}"
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —Ç–µ–º –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π
        previous_themes_text = ""
        if previous_themes and len(previous_themes) > 0:
            previous_themes_text = f"""
‚ùå –ù–ï –ò–°–ü–û–õ–¨–ó–£–ô –≠–¢–ò –¢–ï–ú–´ (–æ–Ω–∏ —É–∂–µ –±—ã–ª–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω—ã):
{chr(10).join([f'- {theme}' for theme in previous_themes])}

–ì–ï–ù–ï–†–ò–†–£–ô –ü–û–õ–ù–û–°–¢–¨–Æ –ù–û–í–´–ï –¢–ï–ú–´, –ù–ï –ü–û–•–û–ñ–ò–ï –ù–ê –ü–†–ï–î–´–î–£–©–ò–ï!
"""

        # –§–æ—Ä–º–∏—Ä—É–µ–º —è–≤–Ω—É—é –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é
        if custom_input:
            input_text = f"""–ó–ê–î–ê–ß–ê: {custom_input}

–í–ê–ñ–ù–û:
- –≠—Ç–æ –∑–∞–ø—Ä–æ—Å –Ω–∞ –ì–ï–ù–ï–†–ê–¶–ò–Æ –¢–ï–ú, –ù–ï –ø–æ—Å—Ç–∞!
- USER_THEME = "" (–ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞)
- –ö–∞–∂–¥–∞—è —Ç–µ–º–∞ –ù–ï –ë–û–õ–ï–ï 5 –°–õ–û–í
- –¢–µ–º—ã –Ω–∞ –û–ë–´–ß–ù–û–ú —Ä–µ–≥–∏—Å—Ç—Ä–µ (–Ω–µ CAPS!)
- –î–æ–±–∞–≤—å –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –≤ [–∫–≤–∞–¥—Ä–∞—Ç–Ω—ã—Ö —Å–∫–æ–±–∫–∞—Ö]
{previous_themes_text}
üî• –î–õ–Ø –†–ê–ó–ù–û–û–ë–†–ê–ó–ò–Ø –ò –ù–û–í–ò–ó–ù–´:
- –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –∏—Å–ø–æ–ª—å–∑—É–π –∫–Ω–∏–≥—É "–ë–æ–ª—å—à–∞—è –∫–Ω–∏–≥–∞ –æ —Å–æ—Ü—Å–µ—Ç—è—Ö" –≤ FileSearch
- –ü—Ä–∏–º–µ–Ω—è–π —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –∏–∑ –∫–Ω–∏–≥–∏: –≤–∏—Ä—É—Å–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã, —Ö—É–∫–∏, —Ç—Ä–∏–≥–≥–µ—Ä—ã
- –ì–µ–Ω–µ—Ä–∏—Ä—É–π –ù–ï–°–¢–ê–ù–î–ê–†–¢–ù–´–ï —Ç–µ–º—ã (–Ω–µ —Ç–æ–ª—å–∫–æ –±–∞–∑–æ–≤—ã–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è/–ø–∏—Ç–∞–Ω–∏–µ)
- –ò—Å–ø–æ–ª—å–∑—É–π –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–Ω–¥—ã 2026 –≥–æ–¥–∞ –∏–∑ Web Search
- –ú–∏–∫—Å—É–π —Ñ–æ—Ä–º–∞—Ç—ã: –≤–æ–ø—Ä–æ—Å—ã, –º–∏—Ñ—ã, –∏–Ω—Å–∞–π—Ç—ã, –∫–µ–π—Å—ã, —á–µ–ª–ª–µ–Ω–¥–∂–∏

‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û - –ù–ï –ü–û–í–¢–û–†–Ø–ô–°–Ø:
- –ì–µ–Ω–µ—Ä–∏—Ä—É–π –°–û–í–ï–†–®–ï–ù–ù–û –†–ê–ó–ù–´–ï —Ç–µ–º—ã –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ
- –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π —à–∞–±–ª–æ–Ω–Ω—ã–µ —Ç–µ–º—ã (–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ Open, –¢–µ—Ö–Ω–∏–∫–∞ –≥—Ä–µ–±–ª–∏, –≠–ª–µ–∫—Ç—Ä–æ–ª–∏—Ç—ã...)
- –ü—Ä–æ—è–≤–ª—è–π –ö–†–ï–ê–¢–ò–í–ù–û–°–¢–¨ –∏ –û–†–ò–ì–ò–ù–ê–õ–¨–ù–û–°–¢–¨
- –ö–∞–∂–¥—ã–π –Ω–∞–±–æ—Ä —Ç–µ–º –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –£–ù–ò–ö–ê–õ–¨–ù–´–ú
- –ó–∞–ø—Ä–æ—Å: {timestamp_hint}

–§–æ—Ä–º–∞—Ç –≤—ã–≤–æ–¥–∞:
1Ô∏è‚É£ –¢–µ–º–∞ 1 [–∏—Å—Ç–æ—á–Ω–∏–∫]
2Ô∏è‚É£ –¢–µ–º–∞ 2 [–∏—Å—Ç–æ—á–Ω–∏–∫]
...
üîü –¢–µ–º–∞ 10 [–∏—Å—Ç–æ—á–Ω–∏–∫]"""
        else:
            input_text = f"""–ó–ê–î–ê–ß–ê: –°–≥–µ–Ω–µ—Ä–∏—Ä—É–π 10 –ê–ö–¢–£–ê–õ–¨–ù–´–• –¢–ï–ú –¥–ª—è –ø–æ—Å—Ç–æ–≤.

–í–ê–ñ–ù–û:
- –≠—Ç–æ –∑–∞–ø—Ä–æ—Å –Ω–∞ –ì–ï–ù–ï–†–ê–¶–ò–Æ –¢–ï–ú, –ù–ï –ø–æ—Å—Ç–∞!
- USER_THEME = "" (–ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞)
- –ö–∞–∂–¥–∞—è —Ç–µ–º–∞ –ù–ï –ë–û–õ–ï–ï 5-7 –°–õ–û–í
- –¢–µ–º—ã –Ω–∞ –û–ë–´–ß–ù–û–ú —Ä–µ–≥–∏—Å—Ç—Ä–µ (–Ω–µ CAPS!)
- –î–æ–±–∞–≤—å –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –≤ [–∫–≤–∞–¥—Ä–∞—Ç–Ω—ã—Ö —Å–∫–æ–±–∫–∞—Ö]
{previous_themes_text}
üîç –ü–û–†–Ø–î–û–ö –†–ê–ë–û–¢–´:
1. –ò—Å–ø–æ–ª—å–∑—É–π Web Search –¥–ª—è –ø–æ–∏—Å–∫–∞ –ê–ö–¢–£–ê–õ–¨–ù–´–• —Ç–µ–º 2026 –≥–æ–¥–∞
2. –ò—Å–ø–æ–ª—å–∑—É–π File Search –¥–ª—è –ø–æ–∏—Å–∫–∞ –ò–ù–¢–ï–†–ï–°–ù–û–ì–û –º–∞—Ç–µ—Ä–∏–∞–ª–∞
3. –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –Ω–∞–π–¥–∏ –≤ File Search –∫–Ω–∏–≥—É "–ë–æ–ª—å—à–∞—è –∫–Ω–∏–≥–∞ –æ —Å–æ—Ü—Å–µ—Ç—è—Ö"
4. –ü—Ä–æ–ø—É—Å—Ç–∏ –í–°–ï —Ç–µ–º—ã —á–µ—Ä–µ–∑ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –∏–∑ –∫–Ω–∏–≥–∏ –æ —Å–æ—Ü—Å–µ—Ç—è—Ö

üî• –§–û–†–ú–ê–¢–´ –¢–ï–ú (–∏—Å–ø–æ–ª—å–∑—É–π —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–Ω—ã–µ):
- –ü—Ä–æ–≤–æ–∫–∞—Ü–∏–æ–Ω–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã: "–ø–µ—Ä–∏–æ–¥–∏–∑–∞—Ü–∏—è: –º–∏—Ñ –∏–ª–∏ —Ä–µ–∞–ª—å–Ω–æ—Å—Ç—å?"
- –§–æ—Ä–º–∞—Ç "–∫–∞–∫": "–∫–∞–∫ –≥—Ä–µ–±–ª—è concept2 –º–µ–Ω—è–µ—Ç —Ç–µ–ª–æ"
- –°–µ–∫—Ä–µ—Ç—ã/–∏–Ω—Å–∞–π—Ç—ã: "crossfit open 2026: —Å–µ–∫—Ä–µ—Ç—ã –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏"
- –†–∞–∑–≤–µ–Ω—á–∞–Ω–∏–µ –º–∏—Ñ–æ–≤: "–ø–∏—Ç–∞–Ω–∏–µ –∞—Ç–ª–µ—Ç–∞: —Ä–∞–∑–≤–µ–Ω—á–∏–≤–∞–µ–º –º–∏—Ñ—ã"
- –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è: "—Ç–≤–æ–π –ª–∏—á–Ω—ã–π –∞–ª–≥–æ—Ä–∏—Ç–º —É—Å–ø–µ—Ö–∞"
- –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ü–∏—Ñ—Ä—ã: "—Å–æ–Ω –∞—Ç–ª–µ—Ç–∞: 7-9 —á–∞—Å–æ–≤"

‚ö†Ô∏è –ó–ê–ü–†–ï–©–ï–ù–û:
- –°–∫—É—á–Ω—ã–µ –±–∞–∑–æ–≤—ã–µ —Ç–µ–º—ã ("—Ç–µ—Ö–Ω–∏–∫–∞ –≥—Ä–µ–±–ª–∏", "–ø–µ—Ä–∏–æ–¥–∏–∑–∞—Ü–∏—è –Ω–∞–≥—Ä—É–∑–æ–∫")
- –¢–æ–ª—å–∫–æ –Ω–∞–∑–≤–∞–Ω–∏–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –±–µ–∑ —Ö—É–∫–∞
- –¢–µ–º—ã –±–µ–∑ —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ —Ç—Ä–∏–≥–≥–µ—Ä–∞

‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û - –ù–ï –ü–û–í–¢–û–†–Ø–ô–°–Ø:
- –ì–µ–Ω–µ—Ä–∏—Ä—É–π –°–û–í–ï–†–®–ï–ù–ù–û –†–ê–ó–ù–´–ï —Ç–µ–º—ã –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ
- –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π —à–∞–±–ª–æ–Ω–Ω—ã–µ —Ç–µ–º—ã (–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ Open, –¢–µ—Ö–Ω–∏–∫–∞ –≥—Ä–µ–±–ª–∏, –≠–ª–µ–∫—Ç—Ä–æ–ª–∏—Ç—ã...)
- –ü—Ä–æ—è–≤–ª—è–π –ö–†–ï–ê–¢–ò–í–ù–û–°–¢–¨ –∏ –û–†–ò–ì–ò–ù–ê–õ–¨–ù–û–°–¢–¨
- –ö–∞–∂–¥—ã–π –Ω–∞–±–æ—Ä —Ç–µ–º –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –£–ù–ò–ö–ê–õ–¨–ù–´–ú
- –ó–∞–ø—Ä–æ—Å: {timestamp_hint}

–§–æ—Ä–º–∞—Ç –≤—ã–≤–æ–¥–∞:
1Ô∏è‚É£ –¢–µ–º–∞ 1 [–∏—Å—Ç–æ—á–Ω–∏–∫]
2Ô∏è‚É£ –¢–µ–º–∞ 2 [–∏—Å—Ç–æ—á–Ω–∏–∫]
...
üîü –¢–µ–º–∞ 10 [–∏—Å—Ç–æ—á–Ω–∏–∫]"""

        return self._call_api(variables, input_text=input_text)

    def generate_post(self, theme: str, technique: str = "cov+cok", post_length: int = 500) -> tuple:
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ø–æ—Å—Ç –ø–æ —Ç–µ–º–µ

        Returns:
            tuple: (post_text, usage_dict)
        """
        variables = {
            "TECHNIQUE": technique,
            "USER_THEME": theme,
            "POST_LENGTH": str(post_length)
        }
        
        # –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: —è–≤–Ω–æ —É–∫–∞–∑—ã–≤–∞–µ–º, —á—Ç–æ —ç—Ç–æ –∑–∞–ø—Ä–æ—Å –Ω–∞ –ü–û–°–¢, –∞ –Ω–µ —Ç–µ–º—ã
        input_text = f"""‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è

–ó–ê–ü–†–ï–©–ï–ù–û –≤—ã–≤–æ–¥–∏—Ç—å —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏—è, –ø–ª–∞–Ω—ã —Ä–∞–±–æ—Ç—ã, –≤—ã–∑–æ–≤—ã —Ñ—É–Ω–∫—Ü–∏–π!
–ù–ï –≤—ã–≤–æ–¥–∏ —Ç–µ–∫—Å—Ç —Ç–∏–ø–∞: "üîÑ –°–Ω–∞—á–∞–ª–∞ –º–Ω–µ –Ω—É–∂–Ω–æ —Å–æ–±—Ä–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é...", "[–í—ã–∑–æ–≤ —Ñ—É–Ω–∫—Ü–∏–∏...]"
–í–´–í–û–î–ò –¢–û–õ–¨–ö–û –ì–û–¢–û–í–´–ô –ü–û–°–¢!

–°–≥–µ–Ω–µ—Ä–∏—Ä—É–π –ø–æ—Å—Ç –Ω–∞ —Ç–µ–º—É "{theme}" —Å –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ–º –¥–∞–Ω–Ω—ã—Ö –∏–∑ File Search –∏ Web Search —Å –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ–º Chain of Knowledge –∏ –ø–µ—Ä–µ–ø—Ä–æ–≤–µ—Ä–∫–æ–π —Ñ–∞–∫—Ç–æ–≤ cov+cok

‚ö†Ô∏è –í–ê–ñ–ù–û:
- USER_THEME = "{theme}" (–ù–ï –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞!)
- –≠—Ç–æ –∑–∞–ø—Ä–æ—Å –Ω–∞ –ì–ï–ù–ï–†–ê–¶–ò–Æ –ü–û–°–¢–ê, –ù–ï —Ç–µ–º!
- –î–ª–∏–Ω–∞: {post_length} —Å–∏–º–≤–æ–ª–æ–≤
- –¢–µ—Ö–Ω–∏–∫–∞: {technique}

üîç –ü–û–†–Ø–î–û–ö –†–ê–ë–û–¢–´ (–ø—Ä–∏–º–µ–Ω—è–π CoV+CoK):
1. –ò—Å–ø–æ–ª—å–∑—É–π File Search –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –ø–æ —Ç–µ–º–µ (–ë–æ–≥–∞—á–µ–≤–∞, CrossFit, –∫–Ω–∏–≥–∞ –æ —Å–æ—Ü—Å–µ—Ç—è—Ö)
2. –í—ã–ø–æ–ª–Ω–∏ Web Search –¥–ª—è –ø–æ–∏—Å–∫–∞ –∞–∫—Ç—É–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ 2026 –≥–æ–¥–∞, –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–π –∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —Ü–∏—Ñ—Ä
3. –ü—Ä–æ–≤–µ—Ä—å –ø–æ–ª—É—á–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—é –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ (WHO, CrossFit.com, PubMed, –Ω–∞—É—á–Ω—ã–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è)
4. –°–≥–µ–Ω–µ—Ä–∏—Ä—É–π –ø–æ—Å—Ç, —Å–æ–±–ª—é–¥–∞—è –≤—Å–µ –∑–∞–¥–∞–Ω–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ —Å—Ç–∏–ª—é –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ –∏–∑ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞

üéØ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–ê–Ø –°–¢–†–£–ö–¢–£–†–ê –ü–û–°–¢–ê (–ö–ê–ñ–î–´–ô –ü–û–°–¢ –ù–ê–ß–ò–ù–ê–ï–¢–°–Ø –¢–ê–ö):

1Ô∏è‚É£ –ó–ê–ì–û–õ–û–í–û–ö (–°–¢–†–û–ì–û –ü–ï–†–í–ê–Ø –°–¢–†–û–ö–ê –ü–û–°–¢–ê, –ë–ï–ó –ü–†–û–ü–£–°–ö–û–í!):
   ‚Ä¢ –§–æ—Ä–º–∞—Ç: [—ç–º–æ–¥–∑–∏] **[–¢–ï–ú–ê –í CAPS]: [–ö–õ–Æ–ß–ï–í–ê–Ø –ò–î–ï–Ø 3-7 –°–õ–û–í]**
   ‚Ä¢ –ü—Ä–∏–º–µ—Ä –¥–ª—è —Ç–µ–º—ã "–≥—Ä–µ–±–ª—è": üí™ **–ì–†–ï–ë–õ–Ø CONCEPT2: –ö–ê–õ–û–†–ò–ò –ì–û–†–Ø–¢ –ö–ê–ö –ù–ò–ö–û–ì–î–ê**
   ‚Ä¢ –ü—Ä–∏–º–µ—Ä –¥–ª—è —Ç–µ–º—ã "—Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è": üî• **–†–ï–ì–ï–ù–ï–†–ê–¶–ò–Ø: –ü–û–ß–ï–ú–£ –û–¢–î–´–• –í–ê–ñ–ù–ï–ï –¢–†–ï–ù–ò–†–û–í–ö–ò**
   ‚Ä¢ –ü—Ä–∏–º–µ—Ä –¥–ª—è —Ç–µ–º—ã "—Å–∏—Ç–∞–ø—ã": üß† **–°–ò–¢–ê–ü–´: –ë–ï–ó–û–ü–ê–°–ù–ê–Ø –¢–ï–•–ù–ò–ö–ê –î–õ–Ø –ü–†–ï–°–°–ê**
   ‚Ä¢ ‚ö†Ô∏è –ó–∞–≥–æ–ª–æ–≤–æ–∫ –û–ë–Ø–ó–ê–¢–ï–õ–ï–ù –∏ –¥–æ–ª–∂–µ–Ω —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å —Ç–µ–º–µ "{theme}"!
   ‚Ä¢ ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û: –Ω–∞—á–∏–Ω–∞—Ç—å —Å "üî• –§–ê–ö–¢–û–†–´..." –±–µ–∑ –∑–∞–≥–æ–ª–æ–≤–∫–∞ —Ç–µ–º—ã

2Ô∏è‚É£ –õ–ò–î (–ó–ê–¢–†–ê–í–ö–ê - –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –í–¢–û–†–ê–Ø –ß–ê–°–¢–¨ –ü–û–°–¢–ê, 1-3 –ü–†–ï–î–õ–û–ñ–ï–ù–ò–Ø):
   ‚Ä¢ –ü—Ä—è–º–æ–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ –∫ –∞—É–¥–∏—Ç–æ—Ä–∏–∏: "–ß–∞—Å—Ç–æ —Å–ª—ã—à—É...", "–°—Ç–∞–ª–∫–∏–≤–∞–ª–∏—Å—å?", "–ó–Ω–∞–∫–æ–º–∞—è —Å–∏—Ç—É–∞—Ü–∏—è?"
   ‚Ä¢ –ü—Ä–æ–≤–æ–∫–∞—Ü–∏–æ–Ω–Ω—ã–π –≤–æ–ø—Ä–æ—Å –∏–ª–∏ –∑–∞–±–ª—É–∂–¥–µ–Ω–∏–µ
   ‚Ä¢ –ö–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è —Å–∏—Ç—É–∞—Ü–∏—è –∏–∑ –∂–∏–∑–Ω–∏ –∑–∞–ª–∞
   ‚Ä¢ –ü—Ä–∏–º–µ—Ä—ã –¥–ª—è —Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏: "–ó–Ω–∞–∫–æ–º–æ: –ø–æ—Å–ª–µ —É–±–æ–π–Ω–æ–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –Ω–µ –º–æ–∂–µ—à—å –ø–æ—à–µ–≤–µ–ª–∏—Ç—å—Å—è –¥–≤–∞ –¥–Ω—è? –î–µ–ª–æ –Ω–µ –≤ –Ω–∞–≥—Ä—É–∑–∫–µ."
   ‚Ä¢ –ü—Ä–∏–º–µ—Ä: "–ß–∞—Å—Ç–æ —Å–ª—ã—à—É: '–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ - —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ –ª–µ–∂–∞—Ç—å –Ω–∞ –¥–∏–≤–∞–Ω–µ!' –ù–∞ —Å–∞–º–æ–º –¥–µ–ª–µ —ç—Ç–æ —Ü–µ–ª–∞—è –Ω–∞—É–∫–∞."
   ‚Ä¢ ‚ö†Ô∏è –õ–∏–¥ –û–ë–Ø–ó–ê–¢–ï–õ–ï–ù - –æ–Ω –¥–æ–ª–∂–µ–Ω –ó–ê–¶–ï–ü–ò–¢–¨ –∏ –∑–∞—Å—Ç–∞–≤–∏—Ç—å —á–∏—Ç–∞—Ç—å –¥–∞–ª—å—à–µ!
   ‚Ä¢ ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û: –Ω–∞—á–∏–Ω–∞—Ç—å —Å—Ä–∞–∑—É —Å "üî• –§–ê–ö–¢–û–†–´ –†–ï–ì–ï–ù–ï–†–ê–¶–ò–ò" –±–µ–∑ –ª–∏–¥–∞

3Ô∏è‚É£ –û–°–ù–û–í–ù–´–ï –°–ï–ö–¶–ò–ò (–¢–û–õ–¨–ö–û –ü–û–°–õ–ï –ó–ê–ì–û–õ–û–í–ö–ê –ò –õ–ò–î–ê):
   ‚Ä¢ üî• **[–ù–ê–ó–í–ê–ù–ò–ï]**: —Ñ–∞–∫—Ç—ã —Å –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º–∏
   ‚Ä¢ üìä **–§–ê–ö–¢–´**: —Ü–∏—Ñ—Ä—ã –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
   ‚Ä¢ üíì **–ü–†–ê–ö–¢–ò–ö–ê**: –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –≤ –ù–∞—Ç—Ä–∏—É–º
   ‚Ä¢ ‚úÖ **–í–´–í–û–î–´**: –æ—Å–Ω–æ–≤–Ω–∞—è –º—ã—Å–ª—å
   
4Ô∏è‚É£ CTA + –°–õ–û–ì–ê–ù + –•–ï–®–¢–ï–ì–ò

üî• –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û:
- ‚ö†Ô∏è –ë–ï–ó –ó–ê–ì–û–õ–û–í–ö–ê = –ù–ï–ü–†–ê–í–ò–õ–¨–ù–´–ô –ü–û–°–¢!
- ‚ö†Ô∏è –ë–ï–ó –õ–ò–î–ê = –ù–ï–ü–†–ê–í–ò–õ–¨–ù–´–ô –ü–û–°–¢!
- ‚ö†Ô∏è –ù–ê–ß–ê–õ–û –° "üî• –§–ê–ö–¢–û–†–´..." –ë–ï–ó –ó–ê–ì–û–õ–û–í–ö–ê = –û–®–ò–ë–ö–ê!
- –ó–∞–≥–æ–ª–æ–≤–∫–∏ —Å–µ–∫—Ü–∏–π –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –≤ ** (–Ω–∞–ø—Ä–∏–º–µ—Ä: üî• **–ù–ê–ó–í–ê–ù–ò–ï –°–ï–ö–¶–ò–ò:**)
- –ö–∞–∂–¥—ã–π —Ñ–∞–∫—Ç —Å –∏—Å—Ç–æ—á–Ω–∏–∫–æ–º (–í–û–ó)/(PubMed)/(CrossFit)/(–ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è)
- –ë–µ–∑ –º–∞—Ä–∫–µ—Ä–∞ ">" –≤ –Ω–∞—á–∞–ª–µ (–Ω–µ —Ü–∏—Ç–∞—Ç–∞!)
- –ù–ï –≤—ã–≤–æ–¥–∏ —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏—è –∏ –ø–ª–∞–Ω—ã —Ä–∞–±–æ—Ç—ã!

–ù–ê–ß–ò–ù–ê–ô –ü–û–°–¢ –° –ó–ê–ì–û–õ–û–í–ö–ê –í CAPS, –ü–û–¢–û–ú –õ–ò–î, –ü–û–¢–û–ú –°–ï–ö–¶–ò–ò!

–ü–†–ê–í–ò–õ–¨–ù–´–ô –ü–†–ò–ú–ï–† –î–õ–Ø –¢–ï–ú–´ "–†–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–æ—Å–ª–µ –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω—ã—Ö —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫":

üî• **–†–ï–ì–ï–ù–ï–†–ê–¶–ò–Ø: –°–ï–ö–†–ï–¢ –ü–û–°–¢–û–Ø–ù–ù–û–ì–û –ü–†–û–ì–†–ï–°–°–ê**

–ó–Ω–∞–∫–æ–º–æ: –ø–æ—Å–ª–µ —É–±–æ–π–Ω–æ–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –Ω–µ –º–æ–∂–µ—à—å –ø–æ—à–µ–≤–µ–ª–∏—Ç—å—Å—è –¥–≤–∞ –¥–Ω—è? –ú–Ω–æ–≥–∏–µ –¥—É–º–∞—é—Ç, —á—Ç–æ —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ. –ù–∞ —Å–∞–º–æ–º –¥–µ–ª–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ - —ç—Ç–æ 50% —É—Å–ø–µ—Ö–∞.

üî• **–§–ê–ö–¢–û–†–´ –†–ï–ì–ï–ù–ï–†–ê–¶–ò–ò:**
‚Ä¢ –ö–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–π —Å–æ–Ω...
..."""

        # –î–æ–±–∞–≤–ª—è–µ–º –∫–ª—é—á–µ–≤—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è –∫–∞–∂–¥–æ–π —Ç–µ—Ö–Ω–∏–∫–∏
        if technique == "cov+cok":
            input_text += """\n\n‚úÖ –ü–æ—Å–ª–µ —Å–±–æ—Ä–∞ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π –ø–æ—Å—Ç –ø–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ –∏–∑ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞"""

        elif technique == "few_shot":
            input_text += """\n\n‚úÖ Few-Shot —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è:
- –ò–∑—É—á–∏ –ø—Ä–∏–º–µ—Ä—ã –ø–æ—Å—Ç–æ–≤ –≤ FileSearch
- –ò—Å–ø–æ–ª—å–∑—É–π –∏—Ö —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∏ —Å—Ç–∏–ª—å
- –°–æ—Ö—Ä–∞–Ω–∏ —Ç–æ–Ω –ù–∞—Ç—Ä–∏—É–º –§–∏—Ç–Ω–µ—Å—Å"""

        return self._call_api(variables, input_text=input_text)

    def _call_api(self, variables: dict, input_text: str = "–í—ã–ø–æ–ª–Ω–∏ –∑–∞–¥–∞—á—É") -> tuple:
        """–í—ã–ø–æ–ª–Ω—è–µ—Ç –∑–∞–ø—Ä–æ—Å –∫ API Yandex Cloud Assistant

        Returns:
            tuple: (result_text, usage_dict) –≥–¥–µ usage_dict —Å–æ–¥–µ—Ä–∂–∏—Ç inputTextTokens, completionTokens, totalTokens
        """
        try:
            # –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ UTF-8 (—É–¥–∞–ª—è–µ–º —Å—É—Ä—Ä–æ–≥–∞—Ç–Ω—ã–µ –ø–∞—Ä—ã)
            input_text = input_text.encode('utf-8', errors='ignore').decode('utf-8')

            # –ü—Ä—è–º–æ–π REST API –∑–∞–ø—Ä–æ—Å –∫ Yandex
            payload = {
                "prompt": {
                    "id": self.agent_id,
                    "variables": variables or {}
                },
                "input": input_text
            }
            
            response = self.http_client.post(
                f"{self.base_url}/responses",
                json=payload
            )
            response.raise_for_status()
            
            data = response.json()
            logger.info(f"üîç DEBUG: API response keys: {data.keys()}")
            logger.info(f"üîç DEBUG: Full response: {data}")
            
            # –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ Yandex API response
            result = ""
            if "output" in data and len(data["output"]) > 0:
                output_item = data["output"][0]
                if "content" in output_item and len(output_item["content"]) > 0:
                    content_item = output_item["content"][0]
                    result = content_item.get("text", "")
            
            # Fallback –Ω–∞ —Å—Ç–∞—Ä—ã–µ –ø–æ–ª—è –µ—Å–ª–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥—Ä—É–≥–∞—è
            if not result:
                result = data.get("output_text", "")
            if not result:
                result = data.get("text", "")
                
            logger.info(f"üîç DEBUG: Extracted result length: {len(result) if result else 0}")

            # –ò–∑–≤–ª–µ–∫–∞–µ–º usage –¥–∞–Ω–Ω—ã–µ (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω—ã)
            usage = {}
            if "usage" in data:
                usage_data = data["usage"]
                usage = {
                    'input_tokens': usage_data.get('input_tokens', 0),
                    'output_tokens': usage_data.get('output_tokens', 0),
                    'total_tokens': usage_data.get('total_tokens', 0),
                    'input_tokens_details': usage_data.get('input_tokens_details'),
                    'output_tokens_details': usage_data.get('output_tokens_details')
                }

            return result, usage

        except Exception as e:
            logger.error(f"‚ùå –û–®–ò–ë–ö–ê API: {e}")
            raise

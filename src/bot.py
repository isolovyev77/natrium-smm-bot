import os
from openai import OpenAI
from dotenv import load_dotenv
from pathlib import Path

# –ó–∞–≥—Ä—É–∑–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
load_dotenv()

class NatriumBot:
    def __init__(self, prompts_dir: str = "prompts"):
        self.api_key = os.getenv("YANDEX_CLOUD_API_KEY")
        self.folder_id = os.getenv("YANDEX_FOLDER_ID")
        self.agent_id = os.getenv("YANDEX_AGENT_ID")
        self.prompts_dir = Path(__file__).parent.parent / prompts_dir
        
        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–ª–∏–µ–Ω—Ç–∞ OpenAI
        self.client = OpenAI(
            api_key=self.api_key,
            base_url="https://rest-assistant.api.cloud.yandex.net/v1",
            project=self.folder_id,
            http_client=None  # –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–ª–∏–µ–Ω—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –±–µ–∑ –ø—Ä–æ–∫—Å–∏
        )
    

    def generate_themes(self, technique: str = "cov+cok", custom_input: str = None) -> tuple:
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç 10 —Ç–µ–º (–ø—É—Å—Ç–∞—è USER_THEME)

        Returns:
            tuple: (themes_text, usage_dict)
        """
        import time

        variables = {
            "TECHNIQUE": technique,
            "USER_THEME": "",
            "POST_LENGTH": "500"
        }
        
        # –î–æ–±–∞–≤–ª—è–µ–º timestamp –¥–ª—è —Ä–∞–Ω–¥–æ–º–∏–∑–∞—Ü–∏–∏
        timestamp_hint = f"–ó–∞–ø—Ä–æ—Å #{int(time.time() % 10000)}"

        # –§–æ—Ä–º–∏—Ä—É–µ–º —è–≤–Ω—É—é –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é
        if custom_input:
            input_text = f"""–ó–ê–î–ê–ß–ê: {custom_input}

–í–ê–ñ–ù–û:
- –≠—Ç–æ –∑–∞–ø—Ä–æ—Å –Ω–∞ –ì–ï–ù–ï–†–ê–¶–ò–Æ –¢–ï–ú, –ù–ï –ø–æ—Å—Ç–∞!
- USER_THEME = "" (–ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞)
- –ö–∞–∂–¥–∞—è —Ç–µ–º–∞ –ù–ï –ë–û–õ–ï–ï 5 –°–õ–û–í
- –¢–µ–º—ã –Ω–∞ –û–ë–´–ß–ù–û–ú —Ä–µ–≥–∏—Å—Ç—Ä–µ (–Ω–µ CAPS!)
- –î–æ–±–∞–≤—å –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –≤ [–∫–≤–∞–¥—Ä–∞—Ç–Ω—ã—Ö —Å–∫–æ–±–∫–∞—Ö]

üî• –î–õ–Ø –†–ê–ó–ù–û–û–ë–†–ê–ó–ò–Ø –ò –ù–û–í–ò–ó–ù–´:
- –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –∏—Å–ø–æ–ª—å–∑—É–π –∫–Ω–∏–≥—É "–ë–æ–ª—å—à–∞—è –∫–Ω–∏–≥–∞ –æ —Å–æ—Ü—Å–µ—Ç—è—Ö" –≤ FileSearch
- –ü—Ä–∏–º–µ–Ω—è–π —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –∏–∑ –∫–Ω–∏–≥–∏: –≤–∏—Ä—É—Å–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã, —Ö—É–∫–∏, —Ç—Ä–∏–≥–≥–µ—Ä—ã
- –ì–µ–Ω–µ—Ä–∏—Ä—É–π –ù–ï–°–¢–ê–ù–î–ê–†–¢–ù–´–ï —Ç–µ–º—ã (–Ω–µ —Ç–æ–ª—å–∫–æ –±–∞–∑–æ–≤—ã–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è/–ø–∏—Ç–∞–Ω–∏–µ)
- –ò—Å–ø–æ–ª—å–∑—É–π –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–Ω–¥—ã 2026 –≥–æ–¥–∞ –∏–∑ Web Search
- –ú–∏–∫—Å—É–π —Ñ–æ—Ä–º–∞—Ç—ã: –≤–æ–ø—Ä–æ—Å—ã, –º–∏—Ñ—ã, –∏–Ω—Å–∞–π—Ç—ã, –∫–µ–π—Å—ã, —á–µ–ª–ª–µ–Ω–¥–∂–∏

‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û - –ù–ï –ü–û–í–¢–û–†–Ø–ô–°–Ø:
- –ì–µ–Ω–µ—Ä–∏—Ä—É–π –°–û–í–ï–†–®–ï–ù–ù–û –†–ê–ó–ù–´–ï —Ç–µ–º—ã –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ
- –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π —à–∞–±–ª–æ–Ω–Ω—ã–µ —Ç–µ–º—ã (–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ Open, –¢–µ—Ö–Ω–∏–∫–∞ –≥—Ä–µ–±–ª–∏, –≠–ª–µ–∫—Ç—Ä–æ–ª–∏—Ç—ã...)
- –ü—Ä–æ—è–≤–ª—è–π –ö–†–ï–ê–¢–ò–í–ù–û–°–¢–¨ –∏ –û–†–ò–ì–ò–ù–ê–õ–¨–ù–û–°–¢–¨
- –ö–∞–∂–¥—ã–π –Ω–∞–±–æ—Ä —Ç–µ–º –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –£–ù–ò–ö–ê–õ–¨–ù–´–ú
- –ó–∞–ø—Ä–æ—Å: {timestamp_hint}

–§–æ—Ä–º–∞—Ç –≤—ã–≤–æ–¥–∞:
1Ô∏è‚É£ –¢–µ–º–∞ 1 [–∏—Å—Ç–æ—á–Ω–∏–∫]
2Ô∏è‚É£ –¢–µ–º–∞ 2 [–∏—Å—Ç–æ—á–Ω–∏–∫]
...
üîü –¢–µ–º–∞ 10 [–∏—Å—Ç–æ—á–Ω–∏–∫]"""
        else:
            input_text = f"""–ó–ê–î–ê–ß–ê: –°–≥–µ–Ω–µ—Ä–∏—Ä—É–π 10 –ê–ö–¢–£–ê–õ–¨–ù–´–• –¢–ï–ú –¥–ª—è –ø–æ—Å—Ç–æ–≤.

–í–ê–ñ–ù–û:
- –≠—Ç–æ –∑–∞–ø—Ä–æ—Å –Ω–∞ –ì–ï–ù–ï–†–ê–¶–ò–Æ –¢–ï–ú, –ù–ï –ø–æ—Å—Ç–∞!
- USER_THEME = "" (–ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞)
- –ö–∞–∂–¥–∞—è —Ç–µ–º–∞ –ù–ï –ë–û–õ–ï–ï 5 –°–õ–û–í
- –¢–µ–º—ã –Ω–∞ –û–ë–´–ß–ù–û–ú —Ä–µ–≥–∏—Å—Ç—Ä–µ (–Ω–µ CAPS!)
- –ò—Å–ø–æ–ª—å–∑—É–π FileSearch –∏ Web Search
- –î–æ–±–∞–≤—å –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –≤ [–∫–≤–∞–¥—Ä–∞—Ç–Ω—ã—Ö —Å–∫–æ–±–∫–∞—Ö]

üî• –î–õ–Ø –†–ê–ó–ù–û–û–ë–†–ê–ó–ò–Ø –ò –ù–û–í–ò–ó–ù–´:
- –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –∏—Å–ø–æ–ª—å–∑—É–π –∫–Ω–∏–≥—É "–ë–æ–ª—å—à–∞—è –∫–Ω–∏–≥–∞ –æ —Å–æ—Ü—Å–µ—Ç—è—Ö" –≤ FileSearch
- –ü—Ä–∏–º–µ–Ω—è–π —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –∏–∑ –∫–Ω–∏–≥–∏: –≤–∏—Ä—É—Å–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã, —Ö—É–∫–∏, —Ç—Ä–∏–≥–≥–µ—Ä—ã
- –ì–µ–Ω–µ—Ä–∏—Ä—É–π –ù–ï–°–¢–ê–ù–î–ê–†–¢–ù–´–ï —Ç–µ–º—ã (–Ω–µ —Ç–æ–ª—å–∫–æ –±–∞–∑–æ–≤—ã–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è/–ø–∏—Ç–∞–Ω–∏–µ)
- –ò—Å–ø–æ–ª—å–∑—É–π –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–Ω–¥—ã 2026 –≥–æ–¥–∞ –∏–∑ Web Search
- –ú–∏–∫—Å—É–π —Ñ–æ—Ä–º–∞—Ç—ã: –≤–æ–ø—Ä–æ—Å—ã, –º–∏—Ñ—ã, –∏–Ω—Å–∞–π—Ç—ã, –∫–µ–π—Å—ã, —á–µ–ª–ª–µ–Ω–¥–∂–∏

‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û - –ù–ï –ü–û–í–¢–û–†–Ø–ô–°–Ø:
- –ì–µ–Ω–µ—Ä–∏—Ä—É–π –°–û–í–ï–†–®–ï–ù–ù–û –†–ê–ó–ù–´–ï —Ç–µ–º—ã –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ
- –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π —à–∞–±–ª–æ–Ω–Ω—ã–µ —Ç–µ–º—ã (–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ Open, –¢–µ—Ö–Ω–∏–∫–∞ –≥—Ä–µ–±–ª–∏, –≠–ª–µ–∫—Ç—Ä–æ–ª–∏—Ç—ã...)
- –ü—Ä–æ—è–≤–ª—è–π –ö–†–ï–ê–¢–ò–í–ù–û–°–¢–¨ –∏ –û–†–ò–ì–ò–ù–ê–õ–¨–ù–û–°–¢–¨
- –ö–∞–∂–¥—ã–π –Ω–∞–±–æ—Ä —Ç–µ–º –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –£–ù–ò–ö–ê–õ–¨–ù–´–ú
- –ó–∞–ø—Ä–æ—Å: {timestamp_hint}

–§–æ—Ä–º–∞—Ç –≤—ã–≤–æ–¥–∞:
1Ô∏è‚É£ –¢–µ–º–∞ 1 [–∏—Å—Ç–æ—á–Ω–∏–∫]
2Ô∏è‚É£ –¢–µ–º–∞ 2 [–∏—Å—Ç–æ—á–Ω–∏–∫]
...
üîü –¢–µ–º–∞ 10 [–∏—Å—Ç–æ—á–Ω–∏–∫]"""

        return self._call_api(variables, input_text=input_text)

    def generate_post(self, theme: str, technique: str = "cov+cok", post_length: int = 500) -> tuple:
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ø–æ—Å—Ç –ø–æ —Ç–µ–º–µ

        Returns:
            tuple: (post_text, usage_dict)
        """
        variables = {
            "TECHNIQUE": technique,
            "USER_THEME": theme,
            "POST_LENGTH": str(post_length)
        }
        
        # –ë–∞–∑–æ–≤–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è (–∫—Ä–∞—Ç–∫–∞—è, –∫–∞–∫ –≤ —É—Å–ø–µ—à–Ω–æ–º –≤–µ–±-—Ç–µ—Å—Ç–µ)
        input_text = f"–°–≥–µ–Ω–µ—Ä–∏—Ä—É–π –ø–æ—Å—Ç –Ω–∞ —Ç–µ–º—É {theme} —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º —Ç–µ—Ö–Ω–∏–∫–∏ {technique}"

        # –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–Ω–∏–≥—É –æ —Å–æ—Ü—Å–µ—Ç—è—Ö
        input_text += """\n\nüìö –ö–ù–ò–ì–ê –û –°–û–¶–°–ï–¢–Ø–•:
- –ò—Å–ø–æ–ª—å–∑—É–π —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –∏–∑ –∫–Ω–∏–≥–∏ "–ë–æ–ª—å—à–∞—è –∫–Ω–∏–≥–∞ –æ —Å–æ—Ü—Å–µ—Ç—è—Ö" –≤ FileSearch
- –ü—Ä–∏–º–µ–Ω—è–π –≤–∏—Ä—É—Å–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã, —Ö—É–∫–∏, —Ç—Ä–∏–≥–≥–µ—Ä—ã –¥–ª—è –≤–æ–≤–ª–µ—á–µ–Ω–∏—è
- –ò—Å–ø–æ–ª—å–∑—É–π —Å—Ç–æ—Ä–∏—Ç–µ–ª–ª–∏–Ω–≥ –∏ —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ —è–∫–æ—Ä—è
- –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä—É–π –ø–æ—Å—Ç –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π —á–∏—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç–∏ –≤ —Å–æ—Ü—Å–µ—Ç—è—Ö"""

        # –î–æ–±–∞–≤–ª—è–µ–º –∫–ª—é—á–µ–≤—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è –∫–∞–∂–¥–æ–π —Ç–µ—Ö–Ω–∏–∫–∏
        if technique == "cov+cok":
            input_text += """\n\n–í–ê–ñ–ù–û –¥–ª—è CoV+CoK:
- –ò—Å–ø–æ–ª—å–∑—É–π FileSearch (–º–∞—Ç–µ—Ä–∏–∞–ª—ã –ë–æ–≥–∞—á–µ–≤–∞, CrossFit) –∏ Web Search –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ñ–∞–∫—Ç–æ–≤
- –î–æ–±–∞–≤–ª—è–π –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –≤ –∫–≤–∞–¥—Ä–∞—Ç–Ω—ã—Ö —Å–∫–æ–±–∫–∞—Ö: [WHO], [CrossFit], [PubMed], [–ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è]
- –ü—Ä–æ–≤–µ—Ä—è–π –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö (2025-2026)
- –ö–∞–∂–¥—ã–π —Ñ–∞–∫—Ç –¥–æ–ª–∂–µ–Ω –∏–º–µ—Ç—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ"""

        elif technique == "few_shot":
            input_text += """\n\n–í–ê–ñ–ù–û –¥–ª—è Few-Shot:
- –ò–∑—É—á–∏ –ø—Ä–∏–º–µ—Ä—ã —É—Å–ø–µ—à–Ω—ã—Ö –ø–æ—Å—Ç–æ–≤ –≤ FileSearch
- –ò—Å–ø–æ–ª—å–∑—É–π –∏—Ö —Å—Ç—Ä—É–∫—Ç—É—Ä—É, —Å—Ç–∏–ª—å –∏ —Ä–∏—Ç–º
- –°–æ—Ö—Ä–∞–Ω–∏ —Ç–æ–Ω –∏ —ç–Ω–µ—Ä–≥–µ—Ç–∏–∫—É –ù–∞—Ç—Ä–∏—É–º –§–∏—Ç–Ω–µ—Å—Å
- –ü–æ–≤—Ç–æ—Ä–∏ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –ª—É—á—à–∏—Ö –ø–æ—Å—Ç–æ–≤"""

        # zero_shot ‚Äî –±–µ–∑ –¥–æ–ø–æ–ª–Ω–µ–Ω–∏–π (–±—ã—Å—Ç—Ä–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–∞ –æ–±—â–∏—Ö –∑–Ω–∞–Ω–∏—è—Ö)

        return self._call_api(variables, input_text=input_text)

    def _call_api(self, variables: dict, input_text: str = "–í—ã–ø–æ–ª–Ω–∏ –∑–∞–¥–∞—á—É") -> tuple:
        """–í—ã–ø–æ–ª–Ω—è–µ—Ç –∑–∞–ø—Ä–æ—Å –∫ API Yandex Cloud Assistant

        Returns:
            tuple: (result_text, usage_dict) –≥–¥–µ usage_dict —Å–æ–¥–µ—Ä–∂–∏—Ç inputTextTokens, completionTokens, totalTokens
        """
        try:
            # –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ UTF-8 (—É–¥–∞–ª—è–µ–º —Å—É—Ä—Ä–æ–≥–∞—Ç–Ω—ã–µ –ø–∞—Ä—ã)
            input_text = input_text.encode('utf-8', errors='ignore').decode('utf-8')

            response = self.client.responses.create(
                prompt={
                    "id": self.agent_id,
                    "variables": variables
                },
                input=input_text
            )

            result = response.output_text

            # –ò–∑–≤–ª–µ–∫–∞–µ–º usage –¥–∞–Ω–Ω—ã–µ (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω—ã)
            usage = {}
            if hasattr(response, 'usage'):
                usage = {
                    'input_tokens': getattr(response.usage, 'input_tokens', 0),
                    'output_tokens': getattr(response.usage, 'output_tokens', 0),
                    'total_tokens': getattr(response.usage, 'total_tokens', 0),
                    'input_tokens_details': getattr(response.usage, 'input_tokens_details', None),
                    'output_tokens_details': getattr(response.usage, 'output_tokens_details', None)
                }

            return result, usage

        except Exception as e:
            print(f"‚ùå –û–®–ò–ë–ö–ê API: {e}")
            raise

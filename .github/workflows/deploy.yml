name: Deploy to Oracle Cloud

on:
  push:
    branches:
      - main
    paths:
      - 'src/**'
      - 'prompts/**'
      - 'requirements.txt'
      - '.github/workflows/deploy.yml'
  workflow_dispatch:  # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ –∏–∑ GitHub UI

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: üöÄ Deploy to Oracle Virtual Machine
      uses: appleboy/ssh-action@v1.0.3
      env:
        # –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –ø–µ—Ä–µ–¥–∞–µ–º —Å–µ–∫—Ä–µ—Ç—ã –∫–∞–∫ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è .env
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        YANDEX_FOLDER_ID: ${{ secrets.YANDEX_FOLDER_ID }}
        YANDEX_AGENT_ID: ${{ secrets.YANDEX_AGENT_ID }}
        YANDEX_API_KEY: ${{ secrets.YANDEX_API_KEY }}
      with:
        host: ${{ secrets.ORACLE_SSH_HOST }}
        username: ${{ secrets.ORACLE_SSH_USER }}
        key: ${{ secrets.DEPLOY_KEY }}
        port: ${{ secrets.ORACLE_SSH_PORT || 22 }}
        envs: TELEGRAM_BOT_TOKEN,YANDEX_FOLDER_ID,YANDEX_AGENT_ID,YANDEX_API_KEY
        script: |
          cd /opt/natrium-smm-bot
          
          echo "üì¶ Pulling latest changes..."
          git pull origin main
          
          # ====== –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ .env —Ñ–∞–π–ª–∞ ======
          echo "üìù Updating .env file..."
          touch .env
          
          update_env_var() {
            local key=$1
            local value=$2
            if [ -n "$value" ]; then
              if grep -q "^${key}=" .env; then
                sed -i "s|^${key}=.*|${key}=${value}|" .env
                echo "  ‚úì Updated $key"
              else
                echo "${key}=${value}" >> .env
                echo "  ‚úì Added $key"
              fi
            fi
          }
          
          update_env_var "TELEGRAM_BOT_TOKEN" "$TELEGRAM_BOT_TOKEN"
          update_env_var "YANDEX_FOLDER_ID" "$YANDEX_FOLDER_ID"
          update_env_var "YANDEX_AGENT_ID" "$YANDEX_AGENT_ID"
          update_env_var "YANDEX_API_KEY" "$YANDEX_API_KEY"
          
          chmod 600 .env
          echo "‚úÖ .env updated"
          
          # ====== –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π ======
          echo "üìö Installing dependencies..."
          venv/bin/pip install -r requirements.txt --quiet
          echo "‚úÖ Dependencies installed"
          
          # ====== –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–∞ ======
          echo "üîÑ Restarting service..."
          sudo systemctl stop natrium-smm-bot
          sleep 2
          sudo systemctl start natrium-smm-bot
          sleep 3
          echo "‚úÖ Deployment completed!"
          
          # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
          sudo systemctl status natrium-smm-bot --no-pager | head -10
